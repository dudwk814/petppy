<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{/fragments/basicLayout :: setContent(~{this::content})}">
    <th:block th:fragment="content">
        <section class="hero-wrap hero-wrap-2" style="background-image: url('/petppy/images/bg_2.jpg');"
                 data-stellar-background-ratio="0.5">
            <div class="overlay"></div>
            <div class="container">
                <div class="row no-gutters slider-text align-items-end">
                    <div class="col-md-9 ftco-animate pb-5">
                        <p class="breadcrumbs mb-2"><span class="mr-2"><a th:href="@{/}" aria-hidden="true"
                                                                          data-toggle="tooltip" data-placement="top"
                                                                          title="메인 페이지로 이동">Home <i
                                class="ion-ios-arrow-forward"></i></a></span>
                            <span class="mr-2"><a aria-hidden="true" data-toggle="tooltip" data-placement="top"
                                                  title="게시판 목록으로 이동"
                                                  th:href="@{/board(page=${requestDTO.page},size=${requestDTO.size})}">Board <i
                                    class="ion-ios-arrow-forward"></i></a></span> <span>Board Read<i
                                    class="ion-ios-arrow-forward"></i></span></p>
                        <h1 class="mb-0 bread">Board</h1>
                    </div>
                </div>
            </div>
        </section>

        <section class="ftco-section ftco-degree-bg">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 ftco-animate">
                        <p class="meta d-flex">
                            <span aria-hidden="true" data-toggle="tooltip" data-placement="top" title="작성자">[[${#strings.substringBefore(board.email,'@')}]]</span>
                            &nbsp;/&nbsp;
                            <span aria-hidden="true" data-toggle="tooltip" data-placement="top" title="작성일">[[${#temporals.format(board.createdDate, 'yyyy-MM-dd HH:mm')}]]</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            <span>
                                <a data-toggle="tooltip" data-placement="top" title="목록으로 돌아가기" class="text-black-50" th:href="@{/board(page=${requestDTO.page},size=${requestDTO.size}, type=${requestDTO.type}, keyword=${requestDTO.keyword})}">목록</a>
                            </span>
                            <th:block sec:authorize="isAuthenticated()">
                                <th:block th:if="${board.email == session.user.email}">
                                    &nbsp; / &nbsp;
                                    <span>
                                        <a data-toggle="tooltip" data-placement="top" title="게시글 수정" class="text-black-50" th:href="@{/board/modify(id=${board.boardId})}">수정</a>
                                    </span> &nbsp; / &nbsp;
                                    <span>
                                        <a data-toggle="tooltip" data-placement="top" title="게시글 삭제" class="text-black-50 board-remove-btn" th:href="@{/#}">삭제</a>
                                    </span>
                                </th:block>
                            </th:block>
                        </p>
                        <h2 class="mb-3" aria-hidden="true" data-toggle="tooltip" data-placement="top" title="제목"
                            th:text="${board.title}"></h2>
                        <hr>
                        <div th:utext="${board.content}">Content</div>

                        <div class="tag-widget post-tag-container mb-5 mt-5">
                            <div class="tagcloud">
                                <a href="#" class="tag-cloud-link">Life</a>
                                <a href="#" class="tag-cloud-link">Sport</a>
                                <a href="#" class="tag-cloud-link">Tech</a>
                                <a href="#" class="tag-cloud-link">Travel</a>
                            </div>
                        </div>

                        <div class="pt-5 mt-5">
                            <h5 class="mb-5">댓글 [[${#numbers.formatInteger(board.commentCount, 0, 'COMMA')}]]개</h5>
                            <ul class="comment-list">
                                <li th:class="comment" th:data-comment="${comment.id}"
                                    th:each="comment : ${commentList}">
                                    <div class="vcard bio">
                                        <img src="/petppy/images/simbolLogo.PNG" alt="Image placeholder">
                                    </div>
                                    <div class="comment-body" th:id='comment-body + ${comment.id}'
                                         th:data-comment="${comment.id}">
                                        [[${#strings.substringBefore(comment.email,'@')}]] &nbsp;/&nbsp;
                                        <span class="meta"> [[${#temporals.format(comment.createdDate, 'yyyy-MM-dd HH:mm')}]] </span>
                                        <p class="comment-content">[[${comment.content}]]</p>
                                        <p class="mr-auto">
                                            <!--<a href="#" class="fa fa-thumbs-o-up text-black-50" aria-hidden="true"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            <a href="#" class="fa fa-thumbs-o-down text-black-50" aria-hidden="true"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-->
                                            <a href="#" class="text-black-50 comment-input" aria-hidden="true"
                                               data-toggle="tooltip" data-placement="top" title="답글 작성">답글</a>
                                            <th:block sec:authorize="isAuthenticated()">
                                                <th:block th:if="${comment.email == session.user.email}">
                                                    /&nbsp;
                                                    <a href="#" class="p2 text-black-50 comment-modify-btn"
                                                       th:data-comment="${comment.id}" aria-hidden="true"
                                                       data-toggle="tooltip" data-placement="top" title="댓글 수정">수정</a>
                                                    &nbsp;/&nbsp;
                                                    <a href="#" class="p2 text-black-50 comment-remove-btn"
                                                       th:data-comment="${comment.id}" aria-hidden="true"
                                                       data-toggle="tooltip" data-placement="top" title="댓글 삭제">삭제</a>
                                                </th:block>
                                            </th:block>
                                        </p>
                                        <p class="d-flex">
                                            <a href="#" class="reply" th:data-comment="${comment.id}">
                                                <i class="fa fa-angle-down fa-lg" aria-hidden="true"></i> 답글
                                                [[${#lists.size(comment.children)}]]개 보기
                                            </a>
                                        </p>
                                    </div>
                                    <th:block th:each="children : ${comment.children}">
                                        <ul class="children">
                                            <li class="comment">
                                                <div class="vcard bio">
                                                    <img src="/petppy/images/simbolLogo.PNG" alt="Image placeholder">
                                                </div>
                                                <div class="comment-body" id="comment-body">
                                                    [[${#strings.substringBefore(children.email,'@')}]] &nbsp;/&nbsp;
                                                    <span class="meta"> [[${#temporals.format(children.createdDate, 'yyyy-MM-dd HH:mm')}]] </span>
                                                    <p class="comment-content" th:text="${children.content}"></p>
                                                    <p class="mr-auto">
                                                        <!--<a href="#" class="fa fa-thumbs-o-up text-black-50" aria-hidden="true"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                        <a href="#" class="fa fa-thumbs-o-down text-black-50" aria-hidden="true"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-->
                                                        <a href="#" class="text-black-50 comment-input"
                                                           aria-hidden="true" data-toggle="tooltip" data-placement="top"
                                                           title="답글 작성">답글</a>
                                                        <th:block sec:authorize="isAuthenticated()">
                                                            <th:block th:if="${children.email == session.user.email}">
                                                                /&nbsp;
                                                                <a href="#" class="p2 text-black-50 comment-modify-btn"
                                                                   th:data-comment="${children.id}" aria-hidden="true"
                                                                   data-toggle="tooltip" data-placement="top"
                                                                   title="댓글 수정">수정</a> &nbsp;/&nbsp;
                                                                <a href="#" class="p2 text-black-50 comment-remove-btn"
                                                                   th:data-comment="${children.id}" aria-hidden="true"
                                                                   data-toggle="tooltip" data-placement="top"
                                                                   title="댓글 삭제">삭제</a>
                                                            </th:block>
                                                        </th:block>
                                                    </p>
                                                    <p class="d-flex justify-content-end dropdown">


                                                    <div class="dropdown-menu" aria-labelledby="commentDropdownBtn">
                                                        <a class="dropdown-item" href="#">Action</a>
                                                        <a class="dropdown-item" href="#">Another action</a>
                                                        <a class="dropdown-item" href="#">Something else here</a>
                                                    </div>
                                                    </p>
                                                </div>
                                            </li>
                                        </ul>
                                    </th:block>
                                </li>
                            </ul>

                            <div class="row mt-5">
                                <div class="col text-center">
                                    <div class="block-27">
                                        <ul>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <!-- END comment-list -->

                            <div class="comment-form-wrap pt-5">
                                <div class="input-group mb-3">
                                    <div class="input-group-prepend">
                                        <div class="vcard bio" style="margin-top: 10px;">
                                            <img src="/petppy/images/simbolLogo.PNG" alt="Image placeholder">
                                        </div>
                                    </div>
                                    <input type="text" id="reply-content" class="form-control" placeholder="댓글을 입력하세요."
                                           aria-label="Recipient's username" aria-describedby="replyAddBtn">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary replyAddBtn" type="button"
                                                id="replyAddBtn">등록
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- .col-md-8 -->
                    <div class="col-lg-4 sidebar pl-lg-5 ftco-animate">
                        <div class="sidebar-box">
                            <!--<form action="#" class="search-form">
                                <div class="form-group">
                                    <span class="fa fa-search"></span>
                                    <input type="text" class="form-control" placeholder="제목 OR 내용 OR 작성자">
                                </div>
                            </form>-->
                            <form action="/board" class="search-form">
                                <input type="hidden" name="page" value="1">
                                <input type="hidden" name="size" value="10">
                                <div class="input-group mb-3" style="width: 400px !important;">
                                    <!--<div class="input-group-prepend">-->
                                    <select class="custom-select" name="type" id="inputGroupSelect02" style="height: 52px !important;">
                                        <option th:selected="${requestDTO.type == null}">Choose...</option>
                                        <option value="t" th:selected="${requestDTO.type == 't'}">제목</option>
                                        <option value="c" th:selected="${requestDTO.type == 'c'}">내용</option>
                                        <option value="w" th:selected="${requestDTO.type == 'w'}">작성자</option>
                                        <option value="tw" th:selected="${requestDTO.type == 'tw'}">제목 or 작성자</option>
                                        <option value="tc" th:selected="${requestDTO.type == 'tc'}">제목 or 내용</option>
                                        <option value="ct" th:selected="${requestDTO.type == 'ct'}">내용 or 작성자</option>
                                        <option value="tcw" th:selected="${requestDTO.type == 'tcw'}">제목 or 내용 or 작성자</option>
                                    </select>
                                    <!--</div>-->
                                    <input style="width: 150px !important;" th:value="${requestDTO.keyword}" name="keyword" type="text" class="form-control" placeholder="제목 OR 내용 OR 작성자" aria-hidden="true" data-toggle="tooltip" data-placement="bottom" title="검색">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="submit" style="width: 55px;"><span class="fa fa-search"></span></button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="sidebar-box ftco-animate">
                            <h3>최근 게시글</h3>
                            <div class="block-21 mb-4 d-flex" th:each="board : ${recentBoardList}">
                                <div class="text">
                                    <h3 class="heading"><a th:href="@{/board/read(id=${board.boardId})}">[[${board.title}]]</a>
                                    </h3>
                                    <div class="meta">
                                        <div><a aria-hidden="true" data-toggle="tooltip" data-placement="top"
                                                title="작성자"><span class="icon-person"></span>
                                            [[${#strings.substringBefore(board.email,'@')}]]</a></div>
                                        <div><a aria-hidden="true" data-toggle="tooltip" data-placement="top"
                                                title="작성일"><span class="icon-calendar"></span>
                                            [[${#temporals.format(board.createdDate, 'yyyy-MM-dd HH:mm')}]]</a></div>
                                        <div><a aria-hidden="true" data-toggle="tooltip" data-placement="top"
                                                title="조회수"><span class="icon-chat"></span> [[${board.hit}]]</a></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-box ftco-animate">
                            <h3>Tag Cloud</h3>
                            <div class="tagcloud">
                                <a href="#" class="tag-cloud-link">cat</a>
                                <a href="#" class="tag-cloud-link">dog</a>
                                <a href="#" class="tag-cloud-link">pet</a>
                                <a href="#" class="tag-cloud-link">bird</a>
                                <a href="#" class="tag-cloud-link">husky</a>
                                <a href="#" class="tag-cloud-link">bulldog</a>
                                <a href="#" class="tag-cloud-link">food</a>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </section> <!-- .section -->
    </th:block>
</th:block>
<script th:inline="javascript">
    $(document).ready(function (e) {

        var boardId = [[${board.boardId}]];

        $(document).on('click', '.commentDropdownBtn', function (e) {
            e.preventDefault();

            $(this).dropdown('toggle');
        })

        $(document).on('click', '.board-remove-btn', function (e) {
            e.preventDefault();

            if (confirm("게시글을 삭제하시겠습니까?") === true) {

                var commentCount = [[${board.commentCount}]]
                // create element (form)
                var boardRemoveForm = $('<form></form>');

                // set attribute(form)
                boardRemoveForm.attr('method', 'post');
                boardRemoveForm.attr('action', '/board/delete');

                // set attribute(input)
                boardRemoveForm.append($('<input/>', {type: 'hidden', name: 'id', value:boardId }));
                // append form (to body)
                boardRemoveForm.appendTo('body');

                // submit form
                boardRemoveForm.submit();
            }
        })

        $('.children').attr('style', 'display:none');

        /* 답글 등록 버튼 클릭 시 답글 등록 */
        $(document).on('click', '.replyAddBtn', function (e) {

            if ([[${session.user == null}]]) {
                $("#loginModal").modal("show");

                return;
            }

            var commentContent = $(this).closest('.input-group').find('#reply-content').val();


            if (commentContent.trim() === "") {
                if ($(this).closest('.input-group').find('#reply-content').hasClass('is-invalid') === true) {
                    $('#reply-content').removeClass("is-invalid");
                }
                $(this).closest(".input-group").find('input').addClass('is-invalid');
                /*$(this).closest(".input-group").append("<div class='invalid-feedback' id='comment-content-invalid-div'>" + "내용을 입력하세요 </div>");*/
                $(this).closest(".input-group").find('input').attr('placeholder', '올바른 내용을 입력해주세요.');
                return;
            }

            [# th:if = "${session.user != null}"]
            var commentDTO = {
                boardId: boardId,
                content: commentContent,
                userId: [[${session.user.id}]],
                email: [[${session.user.email}]],
                parentId: $(this).data("parent")
            };

            $.ajax({
                url: '/comment/' + boardId,
                type: 'post',
                data: JSON.stringify(commentDTO),
                contentType: 'application/json; charset=utf-8',
                dataType: 'text',
                success: function (result) {
                    console.log(result + "번 댓글이 등록되었습니다.");

                    self.location.reload();
                }
            });
            [/]

        });

        /* 답글 클릭 시 답글 작성 input창 생성 */
        $(document).on('click', '.comment-input', function (e) {
            e.preventDefault();

            var commentBody = $(this.closest(".comment-body"));
            var parentId = commentBody.data("comment");


            if (commentBody.children('.input-group').length < 1) {
                $(commentBody).append('<div class="input-group mb-3" th:data-comment-input-group="' + parentId + '">\n' +
                    '                  <div class="input-group-prepend">\n' +
                    '                    <div class="vcard bio" style="margin-top: 10px;">\n' +
                    '                      <img src="/petppy/images/simbolLogo.PNG" alt="Image placeholder">\n' +
                    '                    </div>\n' +
                    '                  </div>\n' +
                    '                  <input type="text" id="reply-content" class="form-control" placeholder="답글을 입력하세요." aria-label="Recipient\'s username" aria-describedby="replyAddBtn">\n' +
                    '                  <div class="input-group-append">\n' +
                    '                    <button class="btn btn-outline-secondary replyAddBtn" type="button" id="replyAddBtn" data-parent="' + parentId + '">답글 등록</button>\n' +
                    '                  </div>\n' +
                    '                </div>');
            } else {
                commentBody.children('.input-group').remove();
                return;
            }
        })

        /* 답글 보기 클릭시 답글 리스트 show & hide  */
        $(document).on('click', '.reply', function (e) {
            e.preventDefault();


            if ($(this).closest('.comment').find('.children').css("display") === 'none') {
                $(this).closest('.comment').find('.children').show();
            } else {
                $(this).closest('.comment').find('.children').hide();
            }
        });

        /* 삭제 클릭 시 확인 후 댓글 삭제 */
        $(document).on('click', '.comment-remove-btn', function (e) {
            e.preventDefault();

            var commentId = $(this).data("comment");

            var commentDTO = {
                boardId: boardId,
                id: commentId
            }

            if (confirm("댓글을 삭제하시겠습니까?") === true) {
                $.ajax({
                    url: '/comment/' + commentId,
                    type: 'delete',
                    data: JSON.stringify(commentDTO),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'text',
                    success: function (result) {
                        console.log(result);

                        self.location.reload();
                    }
                });
            }
        });

        /* 댓글 리스트에서 수정 버튼 클릭 시 comment input창 생성 */
        $(document).on('click', '.comment-modify-btn', function (e) {
            e.preventDefault();

            var commentId = $(this).data("comment");

            if ($(this).closest('.comment-body').find('.input-group').length < 1) {
                $(this).closest('.comment-body').find('.comment-content').before('<div class="input-group mb-3">\n' +
                    '                                    <input type="text" id="modify-content" class="form-control" placeholder="수정할 댓글의 내용을 입력하세요."\n' +
                    '                                           aria-label="Recipient\'s username" aria-describedby="replyAddBtn">\n' +
                    '                                    <div class="input-group-append">\n' +
                    '                                        <button class="btn btn-outline-secondary comment-modify" data-comment="' + commentId + '" type="button"\n' +
                    '                                                id="replyAddBtn">수정\n' +
                    '                                        </button>\n' +
                    '                                    </div>\n' +
                    '                                </div>');
                $(this).closest('.comment-body').find('.comment-content').css('visibility', 'hidden');
                $(this).text('수정 취소');
            } else {
                $(this).closest('.comment-body').find('.input-group').remove();
                $(this).closest('.comment-body').find('.comment-content').css('visibility', 'visible');
                $(this).text('수정');
            }


        });

        /* 댓글 수정창에서 수정 버튼 클릭시 comment 수정 */
        $(document).on('click', '.comment-modify', function () {

            var commentId = $(this).data("comment");
            var commentContent = $(this).closest('.input-group').find('#modify-content').val();

            var commentDTO = {
                id: commentId,
                content: commentContent
            }

            if (confirm("댓들을 수정하시겠습니까?") === true) {
                $.ajax({
                    url: '/comment/' + commentId,
                    type: 'patch',
                    data: JSON.stringify(commentDTO),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'text',
                    success: function (result) {
                        console.log(result + "번 댓글이 수정되었습니다.");

                        self.location.reload();
                    }
                });
            }
        })

    });
</script>
</html>